# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build-ios:
    macos:
      xcode: "14.3.1"
    resource_class: macos.x86.medium.gen2
    environment:
      HOMEBREW_NO_AUTO_UPDATE: 1
    steps:
      - checkout
      - run: brew install cmake ccache zlib
      - run:
          command: |
            python3 platforms/apple/build_xcframework.py \
            --iphoneos_archs arm64 \
            --without dnn \
            --without ml \
            --without stitching \
            --without photo \
            --without objdetect \
            --without gapi \
            --disable PROTOBUF \
            --disable-bitcode \
            --disable-swift \
            --build_only_specified_archs \
            --out build
      - run: cd build && tar -cvf opencv2.xcframework.tar opencv2.xcframework
      - store_artifacts:
          path: ./build/opencv2.xcframework.tar

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build-and-test:
    jobs:
      - build-ios
